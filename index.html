<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI员工指挥中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            background-color: #f3f4f6;
            font-family: sans-serif;
        }
        .container {
            display: flex;
            flex-grow: 1;
        }
        .sidebar {
            width: 300px;
            background-color: #e2e8f0;
            padding: 1rem;
            border-right: 1px solid #cbd5e1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            overflow-y: auto;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal {
            display: flex;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar for Document History -->
        <div class="sidebar">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-blue-800">项目文档库</h2>
                <button id="logout-button" class="px-4 py-2 bg-red-500 text-white rounded-full font-semibold text-sm hover:bg-red-600 transition-colors duration-300">登出</button>
            </div>
            <ul id="doc-list" class="space-y-2 flex-grow">
                <!-- Documents will be dynamically added here -->
            </ul>
        </div>

        <!-- Main Dashboard -->
        <div class="main-content">
            <div class="max-w-4xl mx-auto w-full">
                <h1 class="text-3xl font-bold text-center text-blue-800 mb-4">AI数字公司指挥中心</h1>
                <p id="user-info" class="text-center text-gray-600 mb-2"></p>
                <p class="text-center text-gray-600 mb-8">选择你的AI员工，并分配任务。</p>
                
                <!-- Main App Content (Hidden until authenticated) -->
                <div id="main-app" class="hidden">
                    <!-- Employee Selection -->
                    <div id="employee-selection" class="flex flex-wrap justify-center gap-4 mb-6">
                        <button data-employee="AI架构师" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 bg-gray-200 text-blue-800 hover:bg-blue-100">AI架构师 👩‍💻</button>
                        <button data-employee="AI程序员" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 bg-gray-200 text-blue-800 hover:bg-blue-100">AI程序员 👨‍💻</button>
                        <button data-employee="AI文档员" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 bg-gray-200 text-blue-800 hover:bg-blue-100">AI文档员 ✍️</button>
                        <button data-employee="AI测试员" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 bg-gray-200 text-blue-800 hover:bg-blue-100">AI测试员 🧪</button>
                        <button data-employee="AI市场专员" class="px-6 py-3 rounded-full font-semibold transition-all duration-300 bg-gray-200 text-blue-800 hover:bg-blue-100">AI市场专员 📈</button>
                    </div>

                    <!-- Prompt Input -->
                    <div class="mb-6">
                        <label id="prompt-label" class="block text-gray-700 font-semibold mb-2">你的指令 (请先选择员工):</label>
                        <textarea id="prompt-input" class="w-full h-32 px-4 py-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-all duration-300 resize-none" placeholder="例如：请为MVP的登录功能设计数据库表结构。"></textarea>
                    </div>
                    
                    <!-- Action Button -->
                    <div class="flex justify-center mb-8">
                        <button id="generate-button" class="px-8 py-4 bg-green-500 text-white font-bold rounded-full shadow-md hover:bg-green-600 transition-all duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">提交任务</button>
                    </div>

                    <!-- File Upload Section -->
                    <div class="mb-6 border-t pt-6">
                        <h3 class="text-lg font-bold mb-2 text-blue-800">文档上传</h3>
                        <div class="flex items-center gap-4">
                            <input type="file" id="file-upload" class="flex-grow p-2 rounded-lg border-2 border-gray-300">
                            <button id="upload-button" class="px-4 py-2 bg-blue-500 text-white rounded-full font-semibold hover:bg-blue-600 transition-colors duration-300">上传</button>
                        </div>
                    </div>

                    <!-- Output Display -->
                    <div class="bg-gray-50 rounded-lg p-6 border border-gray-200 min-h-80">
                        <h2 class="text-xl font-bold text-gray-700 mb-4">AI员工的输出:</h2>
                        <div id="output-display" class="whitespace-pre-wrap text-sm text-gray-700 leading-relaxed"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login/Register Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-2 text-center text-blue-800">登录或注册</h2>
            <p class="text-center text-sm text-gray-600 mb-6" id="auth-instructions">请使用你的邮箱注册或登录。新用户无需验证即可使用。</p>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2" for="email">邮箱</label>
                <input id="email" type="email" class="w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-blue-500" placeholder="your.email@example.com">
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2" for="password">密码</label>
                <input id="password" type="password" class="w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-blue-500">
            </div>
            <div class="flex justify-between">
                <button id="login-button" class="px-6 py-3 bg-green-500 text-white rounded-full font-semibold hover:bg-green-600 transition-colors duration-300">登录</button>
                <button id="signup-button" class="px-6 py-3 bg-blue-500 text-white rounded-full font-semibold hover:bg-blue-600 transition-colors duration-300">注册</button>
            </div>
            <p id="auth-message" class="mt-4 text-center text-red-500"></p>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg">
            <div class="flex items-center gap-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <span class="text-gray-700">正在初始化...</span>
            </div>
        </div>
    </div>

    <script>
      // --- Supabase and API Configuration ---
      const SUPABASE_URL = 'https://nayzeswaeqlephcxbkih.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5heXplc3dhZXFsZXBoY3hia2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NTUwOTcsImV4cCI6MjA3MTIzMTA5N30.BgTn4B24Z9s1I9Dc1tNekN6UpmmaUoHyefghKaxSn4U';
      const GEMINI_API_KEY = 'AIzaSyATtpLyZOGJoU28v7GsO6JQ31DnFVTglsc'; // 您需要填入您的API密钥
      
      // --- Admin Whitelist ---
      const ADMIN_EMAILS = ['fshh.cn@gmail.com'];

      let supabase = null;
      let currentUser = null;
      let selectedEmployee = null;

      // 初始化应用
      async function initializeApp() {
          const loadingIndicator = document.getElementById('loading-indicator');
          const authModal = document.getElementById('auth-modal');
          
          try {
              loadingIndicator.classList.remove('hidden');
              
              // 等待 Supabase 库加载
              await waitForSupabase();
              
              // 初始化 Supabase 客户端
              supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
              
              // 检查当前用户状态
              const { data: { session } } = await supabase.auth.getSession();
              
              if (session && session.user) {
                  showApp(session.user);
              } else {
                  hideApp();
              }
              
              // 设置认证状态监听器
              supabase.auth.onAuthStateChange((event, session) => {
                  if (session && session.user) {
                      showApp(session.user);
                  } else {
                      hideApp();
                  }
              });
              
              setupEventListeners();
              
          } catch (error) {
              console.error('初始化失败:', error);
              alert('应用初始化失败，请刷新页面重试。');
          } finally {
              loadingIndicator.classList.add('hidden');
          }
      }

      // 等待 Supabase 库加载
      function waitForSupabase() {
          return new Promise((resolve, reject) => {
              let attempts = 0;
              const maxAttempts = 50;
              
              const check = () => {
                  if (window.supabase) {
                      resolve();
                  } else if (attempts < maxAttempts) {
                      attempts++;
                      setTimeout(check, 100);
                  } else {
                      reject(new Error('Supabase 库加载超时'));
                  }
              };
              
              check();
          });
      }

      function showApp(user) {
          if (!ADMIN_EMAILS.includes(user.email)) {
              const authMessage = document.getElementById('auth-message');
              authMessage.textContent = '您的账号未获批准，请联系管理员。';
              return;
          }
          
          currentUser = user;
          document.getElementById('auth-modal').classList.add('hidden');
          document.getElementById('main-app').classList.remove('hidden');
          document.getElementById('user-info').textContent = `当前用户: ${user.email}`;
          fetchDocuments();
      }

      function hideApp() {
          currentUser = null;
          document.getElementById('auth-modal').classList.remove('hidden');
          document.getElementById('main-app').classList.add('hidden');
          document.getElementById('user-info').textContent = '';
          document.getElementById('doc-list').innerHTML = '';
      }

      function setupEventListeners() {
          // 认证相关事件
          document.getElementById('login-button').addEventListener('click', handleLogin);
          document.getElementById('signup-button').addEventListener('click', handleSignup);
          document.getElementById('logout-button').addEventListener('click', handleLogout);
          
          // 员工选择
          document.querySelectorAll('#employee-selection button').forEach(button => {
              button.addEventListener('click', () => selectEmployee(button));
          });
          
          // 任务提交
          document.getElementById('generate-button').addEventListener('click', handleTaskSubmission);
          
          // 文件上传
          document.getElementById('upload-button').addEventListener('click', handleFileUpload);
      }

      async function handleLogin() {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          const authMessage = document.getElementById('auth-message');
          
          authMessage.textContent = '';
          
          if (!email || !password) {
              authMessage.textContent = '请输入邮箱和密码';
              return;
          }
          
          try {
              const { error } = await supabase.auth.signInWithPassword({ email, password });
              if (error) throw error;
          } catch (error) {
              authMessage.textContent = '登录失败: ' + error.message;
          }
      }

      async function handleSignup() {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          const authMessage = document.getElementById('auth-message');
          
          authMessage.textContent = '';
          
          if (!email || !password) {
              authMessage.textContent = '请输入邮箱和密码';
              return;
          }
          
          if (password.length < 6) {
              authMessage.textContent = '密码至少需要6个字符';
              return;
          }
          
          try {
              const { error } = await supabase.auth.signUp({ email, password });
              if (error) throw error;
              authMessage.textContent = '注册成功！如需要邮箱验证，请检查您的邮箱。';
          } catch (error) {
              authMessage.textContent = '注册失败: ' + error.message;
          }
      }

      async function handleLogout() {
          try {
              await supabase.auth.signOut();
          } catch (error) {
              console.error('登出失败:', error);
          }
      }

      function selectEmployee(button) {
          if (!currentUser) {
              alert('请先登录！');
              return;
          }
          
          // 重置所有按钮样式
          document.querySelectorAll('#employee-selection button').forEach(btn => {
              btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md', 'transform', 'scale-105');
              btn.classList.add('bg-gray-200', 'text-blue-800');
          });
          
          // 激活选中的按钮
          button.classList.remove('bg-gray-200', 'text-blue-800');
          button.classList.add('bg-blue-600', 'text-white', 'shadow-md', 'transform', 'scale-105');
          
          selectedEmployee = button.dataset.employee;
          document.getElementById('prompt-label').textContent = `你的指令 (${selectedEmployee}):`;
          document.getElementById('generate-button').disabled = false;
      }

      async function handleTaskSubmission() {
          if (!currentUser) {
              alert('请先登录！');
              return;
          }
          
          const prompt = document.getElementById('prompt-input').value.trim();
          if (!prompt || !selectedEmployee) {
              document.getElementById('output-display').textContent = '请选择一位AI员工并输入指令。';
              return;
          }
          
          const generateButton = document.getElementById('generate-button');
          const outputDisplay = document.getElementById('output-display');
          
          generateButton.disabled = true;
          generateButton.textContent = '工作进行中...';
          outputDisplay.innerHTML = '<div class="flex justify-center items-center h-32"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>';
          
          try {
              // 获取现有文档作为上下文
              const { data: existingDocs } = await supabase
                  .from('documents')
                  .select('*')
                  .eq('user_id', currentUser.id);
              
              const context = existingDocs 
                  ? existingDocs.map(doc => `[文档来自${doc.employee}] ${doc.title}: ${doc.content}`).join('\n\n')
                  : '';
              
              // 构建完整的提示词
              const fullPrompt = buildFullPrompt(selectedEmployee, prompt, context);
              
              // 调用AI API
              const result = await callGeminiAPI(fullPrompt);
              
              // 显示结果
              outputDisplay.innerHTML = `<pre class="whitespace-pre-wrap">${result}</pre>`;
              
              // 保存文档
              await saveDocument(selectedEmployee, prompt, result);
              
          } catch (error) {
              console.error('任务处理失败:', error);
              outputDisplay.textContent = '任务处理失败，请重试。';
          } finally {
              generateButton.disabled = false;
              generateButton.textContent = '提交任务';
          }
      }

      async function handleFileUpload() {
          if (!currentUser) {
              alert('请先登录！');
              return;
          }
          
          const fileInput = document.getElementById('file-upload');
          const file = fileInput.files[0];
          
          if (!file) {
              alert('请选择一个文件！');
              return;
          }
          
          const uploadButton = document.getElementById('upload-button');
          uploadButton.disabled = true;
          uploadButton.textContent = '上传中...';
          
          try {
              await uploadFile(file);
              fileInput.value = '';
          } catch (error) {
              console.error('文件上传失败:', error);
              alert('文件上传失败！');
          } finally {
              uploadButton.disabled = false;
              uploadButton.textContent = '上传';
          }
      }

      // 获取文档列表
      async function fetchDocuments() {
          if (!currentUser) return;
          
          try {
              const { data, error } = await supabase
                  .from('documents')
                  .select('*')
                  .eq('user_id', currentUser.id)
                  .order('created_at', { ascending: false });

              if (error) throw error;

              renderDocuments(data || []);
              
          } catch (error) {
              console.error('获取文档失败:', error);
          }
      }

      // 渲染文档列表
      function renderDocuments(documents) {
          const docList = document.getElementById('doc-list');
          docList.innerHTML = '';
          
          documents.forEach(doc => {
              const li = document.createElement('li');
              li.className = 'list-item cursor-pointer p-2 rounded-lg hover:bg-blue-200 transition-colors duration-200';
              
              const docTitle = document.createElement('span');
              docTitle.textContent = `${doc.employee}: ${doc.title}`;
              docTitle.className = 'flex-1 cursor-pointer';
              docTitle.onclick = () => {
                  document.getElementById('output-display').innerHTML = `<pre class="whitespace-pre-wrap">${doc.content}</pre>`;
                  document.querySelectorAll('#doc-list li').forEach(item => item.classList.remove('bg-blue-300'));
                  li.classList.add('bg-blue-300');
              };
              
              const actions = document.createElement('div');
              actions.className = 'flex gap-2';
              
              // 下载按钮
              const downloadBtn = document.createElement('button');
              downloadBtn.innerHTML = '↓';
              downloadBtn.className = 'text-blue-600 hover:text-blue-800 text-lg';
              downloadBtn.title = '下载';
              downloadBtn.onclick = () => downloadDocument(doc);
              
              // 删除按钮
              const deleteBtn = document.createElement('button');
              deleteBtn.innerHTML = '✕';
              deleteBtn.className = 'text-red-600 hover:text-red-800 text-lg';
              deleteBtn.title = '删除';
              deleteBtn.onclick = () => deleteDocument(doc);
              
              actions.appendChild(downloadBtn);
              actions.appendChild(deleteBtn);
              
              li.appendChild(docTitle);
              li.appendChild(actions);
              docList.appendChild(li);
          });
      }

      // 保存文档
      async function saveDocument(employee, prompt, content) {
          if (!currentUser) return;
          
          const title = prompt.length > 50 ? prompt.substring(0, 50) + '...' : prompt;
          
          try {
              const { error } = await supabase
                  .from('documents')
                  .insert([{ 
                      employee, 
                      title, 
                      content, 
                      user_id: currentUser.id 
                  }]);
                  
              if (error) throw error;
              
              await fetchDocuments();
              
          } catch (error) {
              console.error('保存文档失败:', error);
          }
      }

      // 下载文档
      function downloadDocument(doc) {
          const blob = new Blob([doc.content], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${doc.title}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
      }

      // 删除文档
      async function deleteDocument(doc) {
          if (!confirm(`确定要删除文档 "${doc.title}" 吗？`)) return;
          
          try {
              const { error } = await supabase
                  .from('documents')
                  .delete()
                  .eq('id', doc.id);
                  
              if (error) throw error;
              
              await fetchDocuments();
              
          } catch (error) {
              console.error('删除文档失败:', error);
              alert('删除文档失败！');
          }
      }

      // 上传文件
      async function uploadFile(file) {
          const fileName = `${currentUser.id}/${Date.now()}_${file.name}`;
          
          try {
              const { data, error } = await supabase.storage
                  .from('documents')
                  .upload(fileName, file);

              if (error) throw error;

              await saveDocument('用户上传', `已上传文件: ${file.name}`, `文件已成功上传到 Supabase Storage。路径: ${data.path}`);
              
          } catch (error) {
              console.error('文件上传失败:', error);
              throw error;
          }
      }

      // 构建完整提示词
      function buildFullPrompt(employee, prompt, context) {
          const productDoc = `
《AI Video Character Lab — 产品文档 v0.1》
1. 产品定位
一句话描述：一个帮助内容创作者"一站式生成AI视频，并保证角色形象一致性"的应用与平台。

目标用户：
- 短视频博主（抖音、快手、小红书、YouTube Shorts）
- 品牌内容团队（想要统一IP形象）
- 教育 & 培训视频制作者（需要长期保持讲师角色）

核心痛点：
- 用 AI 生成视频时，角色形象常常"变脸"，缺乏一致性。
- 内容创作者缺乏技术背景，无法组装复杂的 AI 工具链。
- 现有平台价格高、流程复杂，不能一站式解决问题。

产品价值主张：
- 一站式：上传角色 → 输入脚本 → 一键生成视频。
- 角色一致性：通过"角色 Embedding"机制保证角色长相、服饰、风格稳定。
- 快速：5 分钟内生成 Demo 视频。

2. 产品功能
MVP 必须功能（第1—2周）：
- 角色上传：用户上传 3—5 张同一角色图片，系统生成角色向量（Embedding）。
- 脚本生成：用户输入文字（或上传文稿），系统自动生成分镜脚本。
- 视频生成：通过调用视频生成模型，保持角色一致，生成 30 秒以内视频。
- 视频下载/分享：用户可直接下载视频文件，或复制分享链接。

扩展功能（第3—6周）：
- 角色库：保存多个角色，随时调用。
- 风格模板：日常 vlog、复古、科技感、卡通等。
- 多语言支持：支持中英双语脚本。
- 协作模式：团队多人共享角色库。

3. 技术选型
前端：Next.js + React，托管在 Vercel
后端：FastAPI (Python) 或 Node.js，数据库使用 Supabase
模型调用：视频生成使用 Runway Gen-3、Veo 3、Pika Labs 等

4. 商业模式
- 免费试用：1 分钟视频
- 月订阅：¥99（10 分钟/月） / ¥299（50 分钟/月）
- 企业定制：¥2,999+/月（角色库 + API 接入）
          `;

          return `你是一位专业的${employee}。请根据以下用户指令、项目文档以及其他AI员工的现有工作文档，完成任务。

项目文档：
${productDoc}

其他AI员工的现有工作文档（供你参考）：
${context || '无现有文档。'}

用户指令：
${prompt}`;
      }

      // 调用 Gemini API
      async function callGeminiAPI(textPrompt) {
          if (!GEMINI_API_KEY) {
              return "错误：未设置 Gemini API 密钥。请在代码中填入您的 API 密钥。";
          }
          
          try {
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      contents: [{
                          parts: [{
                              text: textPrompt
                          }]
                      }]
                  })
              });

              if (!response.ok) {
                  throw new Error(`API 调用失败: ${response.status}`);
              }

              const result = await response.json();
              
              if (result.candidates && result.candidates.length > 0) {
                  return result.candidates[0].content.parts[0].text;
              } else {
                  return "生成内容失败，请检查API响应。";
              }
              
          } catch (error) {
              console.error("Gemini API 调用失败:", error);
              return `生成内容时发生错误: ${error.message}`;
          }
      }

      // 页面加载完成后初始化应用
      document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>