<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI 员工指挥中心</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js';

// ======== 配置 ========
const SUPABASE_URL = 'https://nayzeswaeqlephcxbkih.supabase.co';
const SUPABASE_KEY = '你的SUPABASE_KEY或Vercel环境变量';
const ADMIN_EMAILS = ['fshh.cn@gmail.com'];
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// ======== DOM引用 ========
let currentUser = null;
let selectedEmployee = null;

document.addEventListener('DOMContentLoaded', () => {
  const authModal = document.getElementById('auth-modal');
  const mainApp = document.getElementById('main-app');
  const userInfo = document.getElementById('user-info');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginButton = document.getElementById('login-button');
  const signupButton = document.getElementById('signup-button');
  const logoutButton = document.getElementById('logout-button');
  const authMessage = document.getElementById('auth-message');
  const employeeButtons = document.querySelectorAll('#employee-selection button');
  const promptLabel = document.getElementById('prompt-label');
  const promptInput = document.getElementById('prompt-input');
  const generateButton = document.getElementById('generate-button');
  const outputDisplay = document.getElementById('output-display');
  const docList = document.getElementById('doc-list');
  const fileUpload = document.getElementById('file-upload');
  const uploadButton = document.getElementById('upload-button');

  // ======== 登录状态控制 ========
  const showApp = (user) => {
    if (!ADMIN_EMAILS.map(e => e.toLowerCase()).includes(user.email.toLowerCase())) {
      authMessage.textContent = '您的账号未获批准，请联系管理员。';
      authModal.style.display = 'flex';
      return;
    }
    currentUser = user;
    authModal.style.display = 'none';
    mainApp.classList.remove('hidden');
    userInfo.textContent = `当前用户: ${user.email}`;
    fetchDocuments();
  };

  const hideApp = () => {
    currentUser = null;
    authModal.style.display = 'flex';
    mainApp.classList.add('hidden');
    userInfo.textContent = '';
    docList.innerHTML = '';
  };

  supabase.auth.onAuthStateChange((event, session) => {
    if (session?.user) showApp(session.user);
    else hideApp();
  });

  loginButton.addEventListener('click', async () => {
    authMessage.textContent = '';
    const { error } = await supabase.auth.signInWithPassword({
      email: emailInput.value,
      password: passwordInput.value
    });
    if (error) authMessage.textContent = '登录失败: ' + error.message;
  });

  signupButton.addEventListener('click', async () => {
    authMessage.textContent = '';
    const { error } = await supabase.auth.signUp({
      email: emailInput.value,
      password: passwordInput.value
    });
    if (error) authMessage.textContent = '注册失败: ' + error.message;
    else alert('注册成功！请检查邮箱进行验证。');
  });

  logoutButton.addEventListener('click', async () => {
    await supabase.auth.signOut();
  });

  // ======== 文档管理 ========
  const fetchDocuments = async () => {
    if (!currentUser) return;
    const { data, error } = await supabase.from('documents')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false });
    if (error) {
      console.error(error);
      return;
    }
    docList.innerHTML = '';
    data.forEach(doc => {
      const li = document.createElement('li');
      li.className = 'list-item p-2 flex justify-between hover:bg-blue-200 rounded transition';
      const span = document.createElement('span');
      span.textContent = `${doc.employee}: ${doc.title}`;
      span.onclick = () => {
        outputDisplay.innerHTML = `<pre>${doc.content}</pre>`;
        document.querySelectorAll('#doc-list li').forEach(item => item.classList.remove('bg-blue-300'));
        li.classList.add('bg-blue-300');
      };
      li.appendChild(span);

      const actions = document.createElement('div');
      actions.className = 'flex gap-2';

      const downloadBtn = document.createElement('button');
      downloadBtn.innerHTML = '&#x2193;';
      downloadBtn.title = '下载';
      downloadBtn.onclick = () => {
        const blob = new Blob([doc.content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${doc.title}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };
      actions.appendChild(downloadBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.innerHTML = '&#x2715;';
      deleteBtn.title = '删除';
      deleteBtn.onclick = async () => {
        if (confirm(`确定删除 "${doc.title}" 吗？`)) {
          const { error } = await supabase.from('documents').delete().eq('id', doc.id);
          if (error) alert('删除失败！');
          else fetchDocuments();
        }
      };
      actions.appendChild(deleteBtn);

      li.appendChild(actions);
      docList.appendChild(li);
    });
  };

  const saveDocument = async (employee, prompt, content) => {
    if (!currentUser) return;
    const title = prompt.length > 50 ? prompt.substring(0,50)+'...' : prompt;
    await supabase.from('documents').insert([{ employee, title, content, user_id: currentUser.id }]);
    await fetchDocuments();
  };

  // ======== 文件上传 ========
  uploadButton.addEventListener('click', async () => {
    if (!currentUser) return alert('请先登录！');
    const file = fileUpload.files[0];
    if (!file) return alert('请选择文件！');
    const path = `${currentUser.id}/${Date.now()}_${file.name}`;
    const { data, error } = await supabase.storage.from('documents').upload(path, file);
    if (error) alert('上传失败！');
    else {
      alert('上传成功！');
      await saveDocument('用户上传', file.name, `文件路径: ${data.path}`);
    }
  });

  // ======== AI员工选择 ========
  employeeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      if (!currentUser) return alert('请先登录！');
      employeeButtons.forEach(b => b.classList.remove('bg-blue-600','text-white','shadow-md','transform','scale-105'));
      btn.classList.add('bg-blue-600','text-white','shadow-md','transform','scale-105');
      selectedEmployee = btn.dataset.employee;
      promptLabel.textContent = `你的指令 (${selectedEmployee}):`;
      generateButton.disabled = false;
    });
  });

  // ======== 调用Gemini API ========
  const callGeminiAPI = async (textPrompt) => {
    const apiKey = '你的GEMINI_API_KEY';
    const payload = { contents: [{ role: "user", parts: [{ text: textPrompt }] }] };
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();
      if (result.candidates && result.candidates.length>0) return result.candidates[0].content.parts[0].text;
      else return '生成内容失败';
    } catch(e) {
      console.error(e);
      return '调用API出错';
    }
  };

  generateButton.addEventListener('click', async () => {
    if (!currentUser) return alert('请先登录！');
    const prompt = promptInput.value.trim();
    if (!prompt || !selectedEmployee) return outputDisplay.textContent = '请选择AI员工并输入指令';
    generateButton.disabled = true;
    generateButton.textContent = '工作中...';
    outputDisplay.innerHTML = `<div class="flex justify-center items-center"><div class="w-8 h-8 border-4 border-dashed rounded-full animate-spin border-blue-500"></div></div>`;
    const { data: docs } = await supabase.from('documents').select('*').eq('user_id', currentUser.id);
    const context = docs.map(d=>`[${d.employee}] ${d.title}: ${d.content}`).join('\n');
    const textToSend = `${context}\n\n指令: ${prompt}`;
    const output = await callGeminiAPI(textToSend);
    outputDisplay.innerHTML = `<pre>${output}</pre>`;
    await saveDocument(selectedEmployee, prompt, output);
    generateButton.disabled = false;
    generateButton.textContent = '生成';
    promptInput.value = '';
  });
});
</script>
</head>
<body class="bg-gray-100 h-screen flex">

<div class="sidebar w-64 bg-white border-r p-4 flex flex-col">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-bold text-blue-800">项目文档库</h2>
    <button id="logout-button" class="px-3 py-1 bg-red-500 text-white rounded-full text-sm">登出</button>
  </div>
  <ul id="doc-list" class="space-y-2 flex-grow overflow-y-auto"></ul>
</div>

<div class="flex-1 p-6 overflow-auto">
  <div class="max-w-4xl mx-auto w-full">
    <h1 class="text-3xl font-bold text-center text-blue-800 mb-4">AI数字公司指挥中心</h1>
    <p id="user-info" class="text-center text-gray-600 mb-4"></p>
    <div id="main-app" class="hidden space-y-6">
      
      <div id="employee-selection" class="flex gap-4 justify-center mb-4">
        <button data-employee="小红" class="px-4 py-2 border rounded hover:bg-blue-100 transition">小红</button>
        <button data-employee="小明" class="px-4 py-2 border rounded hover:bg-blue-100 transition">小明</button>
        <button data-employee="小白" class="px-4 py-2 border rounded hover:bg-blue-100 transition">小白</button>
      </div>

      <div class="flex flex-col mb-4">
        <label id="prompt-label" class="mb-1 font-semibold text-gray-700">指令:</label>
        <input id="prompt-input" type="text" class="p-3 border rounded w-full" placeholder="请输入指令">
      </div>
      <div class="flex justify-center mb-4">
        <button id="generate-button" class="px-6 py-2 bg-green-500 text-white rounded" disabled>生成</button>
      </div>

      <div id="output-display" class="bg-white p-4 rounded border min-h-[150px] overflow-auto"></div>

      <div class="flex flex-col items-center mt-6">
        <input id="file-upload" type="file" class="mb-2">
        <button id="upload-button" class="px-4 py-2 bg-blue-500 text-white rounded">上传文件</button>
      </div>
    </div>
  </div>
</div>

<!-- 登录弹窗 -->
<div id="auth-modal" class="modal flex justify-center items-center fixed inset-0 bg-black bg-opacity-40 z-50">
  <div class="modal-content bg-white p-6 rounded-lg w-80 mx-auto">
    <h2 class="text-2xl font-bold mb-2 text-center text-blue-800">登录或注册</h2>
    <p class="text-center text-sm text-gray-600 mb-6">请使用你的邮箱注册或登录。</p>
    <input id="email" type="email" placeholder="邮箱" class="w-full mb-4 p-3 border rounded-lg">
    <input id="password" type="password" placeholder="密码" class="w-full mb-4 p-3 border rounded-lg">
    <div class="flex justify-between">
      <button id="login-button" class="px-4 py-2 bg-green-500 text-white rounded-full">登录</button>
      <button id="signup-button" class="px-4 py-2 bg-blue-500 text-white rounded-full">注册</button>
    </div>
    <p id="auth-message" class="mt-4 text-red-500 text-center"></p>
  </div>
</div>

</body>
</html>
